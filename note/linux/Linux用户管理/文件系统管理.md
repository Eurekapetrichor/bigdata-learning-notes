


# 硬盘结构
![](../../../img/linux/文件系统管理/逻辑结构.png)
![](../../../img/linux/文件系统管理/柱面.png)

硬盘的大小是使用 `磁头数×柱面数×扇区数×每个扇区的大小` 这样的公式来计算的。其中磁头数（Heads）表示硬盘总共有几个磁头，也可以理解成为硬盘有几个盘面，然后乘以二；柱面数（Cylinders）表示硬盘每一面盘片有几条磁道；扇区数（Sectors）表示每条磁道上有几个扇区；每个扇区的大小一般是 512Byte。

硬盘接口:
- `IDE 硬盘接口`（Integrated Drive Electronics，并口，即电子集成驱动器）也称作“ATA 硬盘”或“PATA 硬盘”，是早期机械硬盘的主要接口，ATA133 硬盘的理论速度可以达到 133MB/s（此速度为理论平均值）
- `SATA 接口`（Serial ATA，串口）是速度更高的硬盘标准，具备了更高的传输速度，并具备了更强的纠错能力。目前已经是 SATA 三代，理论传输速度达到 600MB/s（此速度为理论平均值）
- `SCSI 接口`（Small Computer System Interface，小型计算机系统接口）广泛应用在服务器上，具有应用范围广、多任务、带宽大、CPU 占用率低及支持热插拔等优点，理论传输速度达到320MB/s

# 文件系统
## 特性
- `super block（超级块）`：记录整个文件系统的信息，包括 block 与 inode 的总量，已经使用的 inode 和 block 的数量，未使用的 inode 和 block 的数量，block 与 inode 的大小，文件系统的挂载时间，最近一次的写入时间，最近一次的磁盘检验时间等。
- `data block（数据块，也称作 block）`：用来实际保存数据的（柜子的隔断），block 的大小（1KB、2KB 或 4KB）和数量在格式化后就已经决定，不能改变，除非重新格式化（制作柜子的时候，隔断大小就已经决定，不能更改，除非重新制作柜子）。每个 blcok 只能保存一个文件的数据，要是文件数据小于一个 block 块，那么这个 block 的剩余空间不能被其他文件是要；要是文件数据大于一个 block 块，则占用多个 block 块。Windows 中磁盘碎片整理工具的原理就是把一个文件占用的多个 block 块尽量整理到一起，这样可以加快读写速度。
- `inode（i 节点，柜子门上的标签）`：用来记录文件的权限（r、w、x），文件的所有者和属组，文件的大小，文件的状态改变时间（ctime），文件的最近一次读取时间（atime），文件的最近一次修改时间（mtime），文件的数据真正保存的 block 编号。每个文件需要占用一个 inode。

## 常见文件系统
| 文件系统 | 描述                                                                                                                                                                                                           |
|---|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| ext | Linux 中最早的文件系统, 由于在性能和兼容性上具有很多缺陷, 现在已经很少使用。                                                                                                                                                                  |
| ext2 | 是 ext 文件系统的升级版本, RedHat Linux7.2版本以前的系统默认都是ext2文件系统. 支持最大 16TB 的分区和最大 2TB 的文件。                                                                                                                               |
| ext3 | 是 ext2 文件系统的升级版本，最大的区别就是带日志功能，在系统突然停止时提高文件系统的可靠性。支持最大 16TB 的分区和最大 2TB 的文件。                                                                                                                                   |
| ext4 | 是 ext3 文件系统的升级版本。ext4 在性能、伸缩性和可靠性方面进行了大量改进。ext4 的变化可以说是翻天覆地的，比如向下兼容 ext3、最大 1EB 文件系统和 16TB 文件、无限数量子目录、Extents 连续数据块概念、多块分配、延迟分配、持久预分配、快速 FSCK、日志校验、无日志模式、在线碎片整理、inode 增强、默认启用 barrier等。它是 CentOS6.x 的默认文件系统。 |
| xfs | XFS 最早针对 IRIX 操作系统开发，是一个高性能的日志型文件系统，能够在断电以及操作系统崩溃的情况下，保证文件系统数据的一致性。它是一个 64 位的文件系统，后来进行开源 并且移植到了 Linux 操作系统中，目前 CentOS7.x 将 XFS+LVM 作为默认的文件系统。据官方所说，XFS 对于大文件的读写性能较好。                                         |
| swap | swap 是 Linux 中用于交换分区的文件系统(类似于 Window 中的虚拟内存), 当内存不够用时, 使用交换分区暂时替代内存。 一般大小为内存的 2 倍, 但是不要超过 2GB。 它是 Linux 系统的必须分区。                                                                                             |
| NFS | NFS 是网络文件系统(Network File System) 的缩写， 是用来实现不同主机之间文件共享的一种网络服务，本地主机可以通过挂载的方式使用远程共享的资源。                                                                                                                         |
| iso9660| 光盘的标准文件系统。Linux 要想使用光盘，必须支持 iso9660 文件系统                                                                                                                                                                     |
| fat | Window 下的 fat16 文件系统，在 Linux 中识别为 fat | 
| vfst | Window 下的 fat32 文件系统，在 Linux 中识别为 vfst，最大支持 32GB 的分区和最大 4GB 文件 |
| NTFS | Window 下的 NTFS 文件系统，不过 Linux 默认是不能识别 NTFS 文件系统的，如果需要识别，则需要重新编译内核才能支持。它比 fat32 文件系统更加安全，速度更快，支持最大 2TB 的分区和最大 62GB 的文件 |
| ufs | Sun 公司的操作系统 Solaris 和 SunOS 所采用的文件系统 |
| proc | Linux 中基于内存的虚拟文件系统，用来管理内存存储目录 /proc |
| sysfs | 和 proc 一样，也是基于内存的虚拟文件系统, 用来管理内存存储目录 /sysfs |
| tmpfs | 也是一种机遇内存的虚拟文件系统, 不过也可以使用 swap 交换分区 |

# 常用硬盘管理命令
df: 统计磁盘空间大小。
```bash
$ df -h
文件系统                                                   容量  已用  可用 已用% 挂载点
devtmpfs                                                    32G     0   32G    0% /dev
tmpfs                                                       32G  4.0K   32G    1% /dev/shm
tmpfs                                                       32G  2.8G   29G    9% /run
tmpfs                                                       32G     0   32G    0% /sys/fs/cgroup
/dev/mapper/centos-root                                     50G   23G   28G   45% /
/dev/nvme0n1p2                                            1014M  190M  825M   19% /boot
/dev/mapper/centos-home                                    871G  524G  348G   61% /home
/dev/nvme0n1p1                                             200M   12M  189M    6% /boot/efi
/dev/sdb                                                   3.6T  319G  3.1T   10% /data2
/dev/sda                                                   3.6T  2.8T  686G   81% /data1
```
du: 统计文件大小
```bash
$ du -sh
8.0K	ams.yaml
0	anaconda3
4.0K	anaconda-ks.cfg
96K	assets
4.0K	cm.yaml
1.4M	com
16K	flink-conf.yaml
4.0K	flink-jaas.conf
4.0K	harbor-api.sh
8.0K	install.sh
```
fsck: 文件系统修复命令,但一般意外关机后,下次开机就会自动运行一次
```bash
$ fsck –y /dev/sdb1
```
dump2fs: 显示磁盘状态
```bash
$ dumpe2fs /dev/sdb
dumpe2fs 1.42.9 (28-Dec-2013)
Filesystem volume name:   <none>     # 卷标名
Last mounted on:          /data2     # 挂载点
Filesystem UUID:          cc779485-7ca9-4a00-89cc-230c6f92c2dd    # UUID
Filesystem magic number:  0xEF53
Filesystem revision #:    1 (dynamic)
Filesystem features:      has_journal ext_attr resize_inode dir_index filetype needs_recovery extent flex_bg sparse_super large_file huge_file uninit_bg dir_nlink extra_isize
Filesystem flags:         signed_directory_hash
Default mount options:    user_xattr acl  # 挂载参数
Filesystem state:         clean           # 文件系统状态: 正常
Errors behavior:          Continue
Filesystem OS type:       Linux
Inode count:              244195328       # inode 总数
Block count:              976754646       # 块总数
Reserved block count:     48837732
Free blocks:              805803638
Free inodes:              242082544
First block:              0
Block size:               4096            # 块大小
Fragment size:            4096
Reserved GDT blocks:      791
Blocks per group:         32768
Fragments per group:      32768
Inodes per group:         8192
Inode blocks per group:   512
Flex block group size:    16
Filesystem created:       Tue May 26 17:34:15 2020
Last mount time:          Thu Aug 17 08:09:16 2023
Last write time:          Thu Aug 17 08:09:16 2023
Mount count:              83
Maximum mount count:      -1
Last checked:             Tue May 26 17:34:15 2020
Check interval:           0 (<none>)
Lifetime writes:          1518 GB
Reserved blocks uid:      0 (user root)
Reserved blocks gid:      0 (group root)
First inode:              11
Inode size:	          256             # inode 大小
Required extra isize:     28
Desired extra isize:      28
Journal inode:            8
First orphan inode:       133435468
Default directory hash:   half_md4
Directory Hash Seed:      da6aaab3-3a87-4bd9-86bc-07d47e841d19
Journal backup:           inode blocks
Journal features:         journal_incompat_revoke
日志大小:             128M
Journal length:           32768
Journal sequence:         0x01b23e58
Journal start:            12699
...
Group 29808: (Blocks 976748544-976754645) [INODE_UNINIT, ITABLE_ZEROED]   # 最后一个数组组内容
  Checksum 0xf1cc, unused inodes 8192
  Block bitmap at 976748544 (+0), Inode bitmap at 976748560 (+16)
  Inode表位于 976748576-976749087 (+32)
  5588 free blocks, 8192 free inodes, 0 directories, 8192个未使用的inodes
  可用块数: 976748545-976748559, 976748561-976748575, 976749088-976754645
  可用inode数: 244187137-244195328
... 
```
stat: 查看文件详情
```bash
$ stat anaconda-ks.cfg
  文件："anaconda-ks.cfg"
  大小：1292      	块：8          IO 块：4096   普通文件
设备：fd00h/64768d	Inode：100663362   硬链接：1
权限：(0600/-rw-------)  Uid：(    0/    root)   Gid：(    0/    root)
最近访问：2021-12-10 09:35:47.949988394 +0800
最近更改：2021-12-10 09:35:47.950988394 +0800
最近改动：2021-12-10 09:35:47.950988394 +0800
创建时间：-
```

# 手动分区
## 查看分区
```bash
# 查看分区
$ fdisk -l 
磁盘 /dev/sda：107.4 GB, 107374182400 字节，209715200 个扇区
Units = 扇区 of 1 * 512 = 512 bytes
扇区大小(逻辑/物理)：512 字节 / 512 字节
I/O 大小(最小/最佳)：512 字节 / 512 字节
磁盘标签类型：dos
磁盘标识符：0x000a0337

   设备 Boot      Start         End      Blocks   Id  System
/dev/sda1   *        2048     2099199     1048576   83  Linux
/dev/sda2         2099200   209715199   103808000   8e  Linux LVM

磁盘 /dev/mapper/centos-root：53.7 GB, 53687091200 字节，104857600 个扇区
Units = 扇区 of 1 * 512 = 512 bytes
扇区大小(逻辑/物理)：512 字节 / 512 字节
I/O 大小(最小/最佳)：512 字节 / 512 字节


磁盘 /dev/mapper/centos-swap：8455 MB, 8455716864 字节，16515072 个扇区
Units = 扇区 of 1 * 512 = 512 bytes
扇区大小(逻辑/物理)：512 字节 / 512 字节
I/O 大小(最小/最佳)：512 字节 / 512 字节


磁盘 /dev/mapper/centos-home：44.1 GB, 44149243904 字节，86228992 个扇区
Units = 扇区 of 1 * 512 = 512 bytes
扇区大小(逻辑/物理)：512 字节 / 512 字节
I/O 大小(最小/最佳)：512 字节 / 512 字节
```
可以看到, 现在系统中一共有一块磁盘: `/dev/sda` `/dev/sda` 磁盘上分了两个区, 分别是 `/dev/sda1`、`/dev/sda2`, 至于剩下的如: `/dev/mapper` 相关的磁盘, 会在后面解释.


## 加硬盘
在 vmware 中添加一块新的硬盘即可. 

## MBR 分区
```bash
# 查看分区信息
$ fdisk -l
磁盘 /dev/sda：107.4 GB, 107374182400 字节，209715200 个扇区
Units = 扇区 of 1 * 512 = 512 bytes
扇区大小(逻辑/物理)：512 字节 / 512 字节
I/O 大小(最小/最佳)：512 字节 / 512 字节
磁盘标签类型：dos
磁盘标识符：0x000a0337

   设备 Boot      Start         End      Blocks   Id  System
/dev/sda1   *        2048     2099199     1048576   83  Linux
/dev/sda2         2099200   209715199   103808000   8e  Linux LVM

磁盘 /dev/sdb：42.9 GB, 42949672960 字节，83886080 个扇区
Units = 扇区 of 1 * 512 = 512 bytes
扇区大小(逻辑/物理)：512 字节 / 512 字节
I/O 大小(最小/最佳)：512 字节 / 512 字节


磁盘 /dev/mapper/centos-root：53.7 GB, 53687091200 字节，104857600 个扇区
Units = 扇区 of 1 * 512 = 512 bytes
扇区大小(逻辑/物理)：512 字节 / 512 字节
I/O 大小(最小/最佳)：512 字节 / 512 字节


磁盘 /dev/mapper/centos-swap：8455 MB, 8455716864 字节，16515072 个扇区
Units = 扇区 of 1 * 512 = 512 bytes
扇区大小(逻辑/物理)：512 字节 / 512 字节
I/O 大小(最小/最佳)：512 字节 / 512 字节


磁盘 /dev/mapper/centos-home：44.1 GB, 44149243904 字节，86228992 个扇区
Units = 扇区 of 1 * 512 = 512 bytes
扇区大小(逻辑/物理)：512 字节 / 512 字节
I/O 大小(最小/最佳)：512 字节 / 512 字节
```
现在看到多了一块磁盘: `/dev/sdb`, 开始分区
```bash
$ fdisk /dev/sdb
欢迎使用 fdisk (util-linux 2.23.2)。

更改将停留在内存中，直到您决定将更改写入磁盘。
使用写入命令前请三思。

Device does not contain a recognized partition table
使用磁盘标识符 0x89f74d63 创建新的 DOS 磁盘标签。

命令(输入 m 获取帮助)：n
```
这里可以输入的信息如下:
- a: 设置可引导标记
- b: 编辑 bsd 磁盘标签
- c: 设置 DOS 操作系统兼容标记
- d: 删除一个分区
- l: 显示已知的文件系统类型
- m: 显示帮助文档
- n: 新建分区
- o: 建立空白 DOS 分区表
- p: 显示分区列表
- q: 不保存退出
- s: 创建空白 SUN 磁盘标签
- t: 改变一个分区的系统 ID
- u: 改变显示记录单位
- v: 验证分区表
- w: 保存退出
- x: 附加功能(仅专家)


```bash
$ fdisk /dev/sdb
欢迎使用 fdisk (util-linux 2.23.2)。

更改将停留在内存中，直到您决定将更改写入磁盘。
使用写入命令前请三思。

Device does not contain a recognized partition table
使用磁盘标识符 0x89f74d63 创建新的 DOS 磁盘标签。

命令(输入 m 获取帮助)：n
Partition type:
   p   primary (0 primary, 0 extended, 4 free)
   e   extended
Select (default p): p    # 每个磁盘必须有一个主分区
分区号 (1-4，默认 1)：     # 分区号默认从1开始, 修改成其他的可能导致浪费磁盘空间
起始 扇区 (2048-83886079，默认为 2048)：    # 分区从什么扇区开始的
Last 扇区, +扇区 or +size{K,M,G} (2048-83886079，默认为 83886079)：+2G # 这里可以直接输入扇区数,也可以输入该分区需要的大小, 如 +2G

命令(输入 m 获取帮助)：p  # 上面已经创建了一个新的主分区, 可以直接查看一下
磁盘 /dev/sdb：42.9 GB, 42949672960 字节，83886080 个扇区
Units = 扇区 of 1 * 512 = 512 bytes
扇区大小(逻辑/物理)：512 字节 / 512 字节
I/O 大小(最小/最佳)：512 字节 / 512 字节
磁盘标签类型：dos
磁盘标识符：0x89f74d63

   设备 Boot      Start         End      Blocks   Id  System
/dev/sdb1            2048     4196351     2097152   83  Linux

命令(输入 m 获取帮助)：n  # 主分区创建之后, 也可以继续创建主分区, 也可以继续创建扩展分区
Partition type:
   p   primary (1 primary, 0 extended, 3 free)
   e   extended
Select (default p): e   # 创建扩展分区, 所有参数用默认的(即剩下空间都是扩展分区)
分区号 (2-4，默认 2)：
起始 扇区 (4196352-83886079，默认为 4196352)：
将使用默认值 4196352
Last 扇区, +扇区 or +size{K,M,G} (4196352-83886079，默认为 83886079)：
将使用默认值 83886079
分区 2 已设置为 Extended 类型，大小设为 38 GiB

命令(输入 m 获取帮助)：p

磁盘 /dev/sdb：42.9 GB, 42949672960 字节，83886080 个扇区
Units = 扇区 of 1 * 512 = 512 bytes
扇区大小(逻辑/物理)：512 字节 / 512 字节
I/O 大小(最小/最佳)：512 字节 / 512 字节
磁盘标签类型：dos
磁盘标识符：0x89f74d63

   设备 Boot      Start         End      Blocks   Id  System
/dev/sdb1            2048     4196351     2097152   83  Linux
/dev/sdb2         4196352    83886079    39844864    5  Extended

命令(输入 m 获取帮助)：n  # 扩展分区无法写入数据, 需要在扩展分区中创建逻辑分区
Partition type:
   p   primary (1 primary, 1 extended, 2 free)
   l   logical (numbered from 5)  # 一个磁盘可以有4个主分区, 不管主分区有没有4个, 逻辑分区都是从5开始的
Select (default p): l
添加逻辑分区 5
起始 扇区 (4198400-83886079，默认为 4198400)：
将使用默认值 4198400
Last 扇区, +扇区 or +size{K,M,G} (4198400-83886079，默认为 83886079)：+2G  # 设置这个逻辑分区大小为2G
分区 5 已设置为 Linux 类型，大小设为 2 GiB

命令(输入 m 获取帮助)：p

磁盘 /dev/sdb：42.9 GB, 42949672960 字节，83886080 个扇区
Units = 扇区 of 1 * 512 = 512 bytes
扇区大小(逻辑/物理)：512 字节 / 512 字节
I/O 大小(最小/最佳)：512 字节 / 512 字节
磁盘标签类型：dos
磁盘标识符：0x89f74d63

   设备 Boot      Start         End      Blocks   Id  System
/dev/sdb1            2048     4196351     2097152   83  Linux
/dev/sdb2         4196352    83886079    39844864    5  Extended
/dev/sdb5         4198400     8392703     2097152   83  Linux

命令(输入 m 获取帮助)：w
The partition table has been altered!

Calling ioctl() to re-read partition table.
正在同步磁盘。
```
到此磁盘分区已经完成, 可以查看分区信息
```bash
$ fdisk -l
磁盘 /dev/sda：107.4 GB, 107374182400 字节，209715200 个扇区
Units = 扇区 of 1 * 512 = 512 bytes
扇区大小(逻辑/物理)：512 字节 / 512 字节
I/O 大小(最小/最佳)：512 字节 / 512 字节
磁盘标签类型：dos
磁盘标识符：0x000a0337

   设备 Boot      Start         End      Blocks   Id  System
/dev/sda1   *        2048     2099199     1048576   83  Linux
/dev/sda2         2099200   209715199   103808000   8e  Linux LVM

磁盘 /dev/sdb：42.9 GB, 42949672960 字节，83886080 个扇区
Units = 扇区 of 1 * 512 = 512 bytes
扇区大小(逻辑/物理)：512 字节 / 512 字节
I/O 大小(最小/最佳)：512 字节 / 512 字节
磁盘标签类型：dos
磁盘标识符：0x89f74d63

   设备 Boot      Start         End      Blocks   Id  System
/dev/sdb1            2048     4196351     2097152   83  Linux
/dev/sdb2         4196352    83886079    39844864    5  Extended
/dev/sdb5         4198400     8392703     2097152   83  Linux

磁盘 /dev/mapper/centos-root：53.7 GB, 53687091200 字节，104857600 个扇区
Units = 扇区 of 1 * 512 = 512 bytes
扇区大小(逻辑/物理)：512 字节 / 512 字节
I/O 大小(最小/最佳)：512 字节 / 512 字节


磁盘 /dev/mapper/centos-swap：8455 MB, 8455716864 字节，16515072 个扇区
Units = 扇区 of 1 * 512 = 512 bytes
扇区大小(逻辑/物理)：512 字节 / 512 字节
I/O 大小(最小/最佳)：512 字节 / 512 字节


磁盘 /dev/mapper/centos-home：44.1 GB, 44149243904 字节，86228992 个扇区
Units = 扇区 of 1 * 512 = 512 bytes
扇区大小(逻辑/物理)：512 字节 / 512 字节
I/O 大小(最小/最佳)：512 字节 / 512 字节
```

### 格式化
分区创建之后, 需要将每一个分区格式化, `parted -l` 命令可以查看未挂载的文件系统类型, 以及哪些分区尚未格式化
```bash
$ parted -l
Model: VMware, VMware Virtual S (scsi)
Disk /dev/sda: 107GB
Sector size (logical/physical): 512B/512B
Partition Table: msdos
Disk Flags:

Number  Start   End     Size    Type     File system  标志
 1      1049kB  1075MB  1074MB  primary  xfs          启动
 2      1075MB  107GB   106GB   primary               lvm


Model: VMware, VMware Virtual S (scsi)
Disk /dev/sdb: 42.9GB
Sector size (logical/physical): 512B/512B
Partition Table: msdos
Disk Flags:

Number  Start   End     Size    Type      File system  标志
 1      1049kB  2149MB  2147MB  primary                        # 这里可以看到分区没有文件系统
 2      2149MB  42.9GB  40.8GB  extended
 5      2150MB  4297MB  2147MB  logical


Model: Linux device-mapper (linear) (dm)
Disk /dev/mapper/centos-home: 44.1GB
Sector size (logical/physical): 512B/512B
Partition Table: loop
Disk Flags:

Number  Start  End     Size    File system  标志
 1      0.00B  44.1GB  44.1GB  xfs


Model: Linux device-mapper (linear) (dm)
Disk /dev/mapper/centos-swap: 8456MB
Sector size (logical/physical): 512B/512B
Partition Table: loop
Disk Flags:

Number  Start  End     Size    File system     标志
 1      0.00B  8456MB  8456MB  linux-swap(v1)


Model: Linux device-mapper (linear) (dm)
Disk /dev/mapper/centos-root: 53.7GB
Sector size (logical/physical): 512B/512B
Partition Table: loop
Disk Flags:

Number  Start  End     Size    File system  标志
 1      0.00B  53.7GB  53.7GB  xfs


警告: 无法以读写方式打开 /dev/sr0 (只读文件系统)。/dev/sr0 已按照只读方式打开。
Model: NECVMWar VMware SATA CD01 (scsi)
Disk /dev/sr0: 10.2GB
Sector size (logical/physical): 2048B/2048B
Partition Table: msdos
Disk Flags:

Number  Start   End     Size    Type     File system  标志
 2      11.7MB  47.8MB  36.0MB  primary
```
格式化
```bash
$ mkfs -t ext4 /dev/sdb1
mke2fs 1.42.9 (28-Dec-2013)
文件系统标签=
OS type: Linux
块大小=4096 (log=2)
分块大小=4096 (log=2)
Stride=0 blocks, Stripe width=0 blocks
131072 inodes, 524288 blocks
26214 blocks (5.00%) reserved for the super user
第一个数据块=0
Maximum filesystem blocks=536870912
16 block groups
32768 blocks per group, 32768 fragments per group
8192 inodes per group
Superblock backups stored on blocks:
	32768, 98304, 163840, 229376, 294912

Allocating group tables: 完成
正在写入inode表: 完成
Creating journal (16384 blocks): 完成
Writing superblocks and filesystem accounting information: 完成

$ mkfs -t ext4 /dev/sdb5
mke2fs 1.42.9 (28-Dec-2013)
文件系统标签=
OS type: Linux
块大小=4096 (log=2)
分块大小=4096 (log=2)
Stride=0 blocks, Stripe width=0 blocks
131072 inodes, 524288 blocks
26214 blocks (5.00%) reserved for the super user
第一个数据块=0
Maximum filesystem blocks=536870912
16 block groups
32768 blocks per group, 32768 fragments per group
8192 inodes per group
Superblock backups stored on blocks:
	32768, 98304, 163840, 229376, 294912

Allocating group tables: 完成
正在写入inode表: 完成
Creating journal (16384 blocks): 完成
Writing superblocks and filesystem accounting information: 完成
```
mkfs 命令简单易用, 但是不能调整分区的默认参数的(比如块大小是4096), 这些默认参数除非特殊情况, 否则不需要调整, 如果需要调整, 需要使用 `mke2fs` 命令进行重新格式化。
```bash
# 语法
$ mke2fs [选项] 分区设备文件名
# 示例: 格式化分区, 并指定 block 的大小为 2048 
$ mke2fs -t ext4 -b 2048 /dev/sdb6
```
选项：
- `-t` 文件系统： 指定格式化成哪个文件系统，如 ext2，ext3，ext4
- `-b` 字节： 指定 block 块的大小
- `-i` 字节： 指定“字节/inode”的比例，也就是多少个字节分配一个 inode
- `-j` 建立带有 ext3 日志功能的文件系统
- `-L` 卷标名： 给文件系统设置卷标名，就不使用 e2label 命令设定了

此时再次查看文件系统类型
```bash
$ parted -l 
Model: VMware, VMware Virtual S (scsi)
Disk /dev/sda: 107GB
Sector size (logical/physical): 512B/512B
Partition Table: msdos
Disk Flags:

Number  Start   End     Size    Type     File system  标志
 1      1049kB  1075MB  1074MB  primary  xfs          启动
 2      1075MB  107GB   106GB   primary               lvm


Model: VMware, VMware Virtual S (scsi)
Disk /dev/sdb: 42.9GB
Sector size (logical/physical): 512B/512B
Partition Table: msdos
Disk Flags:

Number  Start   End     Size    Type      File system  标志
 1      1049kB  2149MB  2147MB  primary   ext4              # 文件系统是 ext4 类型的
 2      2149MB  42.9GB  40.8GB  extended
 5      2150MB  4297MB  2147MB  logical   ext4              # 文件系统是 ext4 类型的
... 
```

### 建立挂载点并挂载
格式化之后, 即可以开始手动挂载了
```bash
## 创建挂载点
$ mkdir -p /app/data1
$ mkdir -p /app/data2

## 挂载
$ mount /dev/sdb1 /app/data1
$ mount /dev/sdb5 /app/data2
```
此时可以使用 `mount` 命令查看已经挂载的分区
```bash
$ mount 
sysfs on /sys type sysfs (rw,nosuid,nodev,noexec,relatime,seclabel)
proc on /proc type proc (rw,nosuid,nodev,noexec,relatime)
...
# 刚挂载上来的两个新分区
/dev/sdb1 on /app/data1 type ext4 (rw,relatime,seclabel,data=ordered)
/dev/sdb5 on /app/data2 type ext4 (rw,relatime,seclabel,data=ordered)
```

### 自动挂载
系统默认的自动挂载
```bash
$ vim /etc/fstab
#
# /etc/fstab
# Created by anaconda on Sat Sep 16 01:06:48 2023
#
# Accessible filesystems, by reference, are maintained under '/dev/disk'
# See man pages fstab(5), findfs(8), mount(8) and/or blkid(8) for more info
#
/dev/mapper/centos-root /                       xfs     defaults        0 0
UUID=2f4b2c7c-638a-40e9-bb72-5074c8e1597e /boot                   xfs     defaults        0 0
/dev/mapper/centos-home /home                   xfs     defaults        0 0
/dev/mapper/centos-swap swap                    swap    defaults        0 0
```
查看分区UUID
```bash
$ dumpe2fs /dev/sdb1 | grep UUID
# 或者 
$ ll /dev/dist/by-uuid总用量 0
lrwxrwxrwx. 1 root root 10 9月  17 23:49 0f7bee7b-02fe-4229-bda9-3656be3a6bff -> ../../sdb5
lrwxrwxrwx. 1 root root  9 9月  17 23:18 2020-11-02-15-15-23-00 -> ../../sr0
lrwxrwxrwx. 1 root root 10 9月  17 23:49 2f4b2c7c-638a-40e9-bb72-5074c8e1597e -> ../../sda1
lrwxrwxrwx. 1 root root 10 9月  17 23:49 58ac1ee5-df7b-4fd0-a026-46d0d86651bd -> ../../dm-1
lrwxrwxrwx. 1 root root 10 9月  17 23:49 a0ff8fcf-a2bf-4dae-be74-be4bd9bcc2cc -> ../../dm-2
lrwxrwxrwx. 1 root root 10 9月  17 23:49 b443b91f-bda0-437e-837e-417a6fbddad1 -> ../../dm-0
lrwxrwxrwx. 1 root root 10 9月  17 23:49 c833600a-47f4-45d7-9909-641e9d64f462 -> ../../sdb1
```
手动挂载
```bash
$ vim /etc/fstab
# 可以写
UUID=c833600a-47f4-45d7-9909-641e9d64f462       /app/data1      ext4 defaults 0 0
UUID=0f7bee7b-02fe-4229-bda9-3656be3a6bff       /app/data2      ext4 defaults 0 0
# 也可以写(二选一)
/dev/sdb1 /app/data1      ext4 defaults 0 0
/dev/sdb5 /app/data2      ext4 defaults 0 0
```
该文件的参数说明:
- `第一列`: 设备文件名
- `第二列`: 挂载点
- `第三列`: 文件系统
- `第四列`: 挂载选项
- `第五列`: 是否可以被备份   0 不备份 1 每天备份 2 不定期备份
- `第六列`: 是否检测磁盘 fsck   0 不检测  1 启动时检测 2 启动后检测

校验自动挂载是否有误
```bash
$ mount -a
```
如果无输出, 表示没有问题, 如果自动挂载有误, 会导致系统无法启动。

### 自动挂载错误修复
先调整一个错误信息
```bash
$ vim /etc/fstab
# 将 c833600a-47f4-45d7-9909-641e9d64f462 改成 c833600a-47f4-45d7-9909-641e9d64f463
UUID=c833600a-47f4-45d7-9909-641e9d64f463       /app/data1      ext4 defaults 0 0
UUID=0f7bee7b-02fe-4229-bda9-3656be3a6bff       /app/data2      ext4 defaults 0 0
```
重启系统
```bash
$ reboot
```
重启之后, 系统无法启动, 只能在服务器上操作, 开机后可以看到如下信息:
![](../../../img/linux/文件系统管理/挂载错误.png)
这里只能输入root账户的密码才能登录, 登录系统之后, 修改自动挂载文件
```bash
$ vim /etc/fstab
```
在保存的时候会发现这是一个只读文件, 因为系统无法正常启动导致的, 需要重新挂载一下根分区
```bash
$ mount -o remount,rw /
```
再将文件修改正常之后重新启动即可。


## parted GPT分区
### 准备分区

### print 查看分区

### 将已有分区修改成 GPT 分区

### 建立分区

### 格式化建立文件系统

### 调整分区大小

### 删除分区

## swap 分区

# 磁盘配额
## 磁盘配额的条件

## 准备分区

## 在分区上开启磁盘配额功能

## SELinux 开关

## 建立磁盘配额的配置文件

## 设置用户和组的配额限制

## 启动和关闭配额

## 测试

## 配额复制

## 非交互设定用户磁盘配额

## 修改宽限时间

# LVM逻辑卷管理
## 物理卷

## 卷组

## 逻辑卷